<div class="app-container" [class.drawer-open]="drawerOpen() && useDrawer()">
  <header class="app-header">
    <button z-button zType="ghost" zSize="sm" class="hamburger" (click)="toggleDrawer()" *ngIf="useDrawer()">
      <span class="icon-menu text-xl"></span>
    </button>
    <h1>F1 Track Visualizer
      <button type="button" class="help-btn" (click)="openHelp()" aria-label="Open help" title="Simulator Help">?</button>
    </h1>
  </header>

  <!-- Desktop / Large layout -->
  <div class="content-wrapper" *ngIf="!useDrawer(); else mobileLayout">
    <aside class="left-panel">
      <div class="info-card">
        <z-badge [ngStyle]="{margin: '10px 0'}">Drivers</z-badge>
        <app-drivers></app-drivers>
      </div>
      <div class="info-card">
        <z-badge [ngStyle]="{margin: '10px 0'}">Race Info</z-badge>
        <app-controls></app-controls>
        <app-race-info></app-race-info>
      </div>
      <div class="info-card">
        <z-badge [ngStyle]="{margin: '10px 0'}">Live Positions</z-badge>
        <app-positions></app-positions>
      </div>
    </aside>

    <main class="main-content">
      <div class="detached-hud-bar" *ngIf="hudDetach()">
        <div class="detached-session" *ngIf="(animation?.sessionName$ | async) as sessionName" [title]="sessionName">{{ sessionName }}</div>
  <div class="detached-lap" *ngIf="(animation?.currentLapInfo$ | async) as lap">Lap {{ lap.lapNumber || '?' }} ‚Ä¢ <span *ngIf="lap.lapDuration as ld">{{ ld | number:'1.2-2' }}s</span> <span *ngIf="lap.speedTrap as st">‚Ä¢ Trap {{ st }} km/h</span></div>
        <div class="detached-controls">
          <button class="hud-btn" (click)="animation?.playPause()" [title]="animation?.getIsPlaying() ? 'Pause' : 'Play'">{{ animation?.getIsPlaying() ? '‚è∏' : '‚ñ∂' }}</button>
          <button class="hud-btn" (click)="animation?.restart()" title="Restart">‚Üª</button>
            <button class="hud-btn" (click)="animation?.decreaseSpeed()" title="Slower">‚àí</button>
            <div class="speed-display">{{ animation?.getSpeedMultiplier() }}x</div>
            <button class="hud-btn" (click)="animation?.increaseSpeed()" title="Faster">+</button>
            <!-- <button class="hud-btn toggle" (click)="animation && animation.animationControlService.toggleShowAllDrivers()" title="Toggle drivers">üë•</button> -->
        </div>
      </div>
      <div class="main-animation">
        <app-animation #animation></app-animation>
      </div>
      <div class="comments-section">
        <h2>Comments</h2>
        <app-comments></app-comments>
      </div>
    </main>
  </div>

  <!-- Mobile / Tablet layout -->
  <ng-template #mobileLayout>
    <div class="responsive-wrapper">
      <!-- Simulated Drawer using dialog base styles -->
      <div class="drawer-mask" *ngIf="drawerOpen()" (click)="closeDrawer()"></div>
      <div class="drawer-panel" [class.open]="drawerOpen()">
        <div class="drawer-header">
          <h3 class="drawer-title">Race Panels</h3>
          <button z-button zType="ghost" zSize="sm" (click)="closeDrawer()"><span class="icon-x"></span></button>
        </div>
        <z-accordion zType="single" [zDefaultValue]="'positions'" class="drawer-accordion">
          <z-accordion-item zTitle="Race Positions" zValue="positions">
            <app-positions></app-positions>
          </z-accordion-item>
          <z-accordion-item zTitle="Drivers" zValue="drivers">
            <app-drivers></app-drivers>
          </z-accordion-item>
          <z-accordion-item zTitle="Race Info" zValue="raceinfo">
            <app-controls></app-controls>
            <app-race-info></app-race-info>
          </z-accordion-item>
        </z-accordion>
      </div>

      <main class="main-content mobile">
        <div class="detached-hud-bar" *ngIf="hudDetach()">
          <div class="detached-session" *ngIf="(animationMob?.sessionName$ | async) as sessionName" [title]="sessionName">{{ sessionName }}</div>
          <div class="detached-lap" *ngIf="(animationMob?.currentLapInfo$ | async) as lap">Lap {{ lap.lapNumber || '?' }} ‚Ä¢ <span *ngIf="lap.lapDuration as ld">{{ ld | number:'1.2-2' }}s</span> <span *ngIf="lap.speedTrap as st">‚Ä¢ Trap {{ st }} km/h</span></div>
          <div class="detached-controls">
            <button class="hud-btn" (click)="animationMob?.playPause()" [title]="animationMob?.getIsPlaying() ? 'Pause' : 'Play'">{{ animationMob?.getIsPlaying() ? '‚è∏' : '‚ñ∂' }}</button>
            <button class="hud-btn" (click)="animationMob?.restart()" title="Restart">‚Üª</button>
            <button class="hud-btn" (click)="animationMob?.decreaseSpeed()" title="Slower">‚àí</button>
            <div class="speed-display">{{ animationMob?.getSpeedMultiplier() }}x</div>
            <button class="hud-btn" (click)="animationMob?.increaseSpeed()" title="Faster">+</button>
            <!-- <button class="hud-btn toggle" (click)="animationMob && animationMob.animationControlService.toggleShowAllDrivers()" title="Toggle drivers">üë•</button> -->
          </div>
        </div>
        <div class="main-animation">
          <app-animation #animationMob></app-animation>
        </div>
        <z-card class="mobile-comments" zTitle="Comments">
          <app-comments></app-comments>
        </z-card>
      </main>
    </div>
  </ng-template>

  <footer class="app-footer">
    <p>&copy; 2025 Lexis Nexis - Motorsport Analytics</p>
  </footer>
</div>
<app-loading></app-loading>
<router-outlet />

<!-- Help Modal -->
<div class="help-overlay" *ngIf="helpOpen()" (click)="closeHelp()">
  <div class="help-dialog" role="dialog" aria-modal="true" aria-label="Simulator Help" (click)="$event.stopPropagation()">
    <header class="help-header">
      <h2>Simulator Guide</h2>
      <button class="close" (click)="closeHelp()" aria-label="Close help">√ó</button>
    </header>
    <div class="help-body">
      <section class="intro">
        <p>Explore the live Formula 1 session: monitor drivers, analyze telemetry-like cues, and control a time-synced replay. Use this guide to unlock every panel.</p>
        <ul class="quick-tips">
          <li><strong>Ctrl/Cmd + Scroll</strong>: zoom canvas</li>
          <li><strong>Space</strong>: play / pause simulation</li>
          <li><strong>Esc</strong>: close dialogs</li>
        </ul>
      </section>
      <z-accordion zType="multiple" class="help-accordion">
        <z-accordion-item zTitle="Drivers" zValue="drivers-help">
          <div class="help-block">
            <p>The Drivers panel lists every car currently in session order (or last known). Use the checklist to toggle visibility:</p>
            <ul>
              <li><strong>Checked</strong>: Car is rendered on track.</li>
              <li><strong>Unchecked</strong>: Car is hidden (not removed from timing logic).</li>
              <li><strong>Select All / None</strong>: Bulk toggle for rapid focus (e.g., just leaders or a battle pack).</li>
            </ul>
          </div>
        </z-accordion-item>
        <z-accordion-item zTitle="Race Info" zValue="raceinfo-help">
          <div class="help-block">
            <p>Switch between <em>sessions</em> (e.g., Practice, Qualifying segments, Race) if data is available. Displays contextual metadata:</p>
            <ul>
              <li><strong>Date & Local Time</strong></li>
              <li><strong>Circuit & Country</strong></li>
              <li><strong>Weather Snapshot</strong>: Temperature, wind, conditions (where provided)</li>
            </ul>
            <p>Session changes reinitialize playback context.</p>
          </div>
        </z-accordion-item>
        <z-accordion-item zTitle="Live Positions" zValue="positions-help">
          <div class="help-block">
            <p>A live leaderboard style stream tracking evolving order:</p>
            <ul>
              <li><strong>Position #</strong> updates as overtakes are computed.</li>
              <li><strong>Speed & Gear</strong> give a snapshot of current state (approximate display).</li>
              <li>Use alongside the canvas to validate strategic moves.</li>
            </ul>
          </div>
        </z-accordion-item>
        <z-accordion-item zTitle="Comments" zValue="comments-help">
          <div class="help-block">
            <p>Stream of contextual commentary or synthesized notes highlighting key race moments, incidents, pace shifts, and strategy beats.</p>
            <p>Use it to jump back mentally to pivotal laps while scrubbing or replaying.</p>
          </div>
        </z-accordion-item>
        <z-accordion-item zTitle="Simulation Controls" zValue="simulation-help">
          <div class="help-block">
            <p>The playback HUD manipulates temporal flow and view:</p>
            <ul>
              <li><strong>Play / Pause</strong>: Toggle real-time progression of positional interpolation.</li>
              <li><strong>Restart</strong>: Return to lap 1 / initial state.</li>
              <li><strong>Speed ‚àí / +</strong>: Adjust multiplier (e.g., 0.5x for analysis, 4x to fast-forward).</li>
              <li><strong>Zoom</strong>: Mouse wheel or pinch (touch) to scale viewport around pointer focus.</li>
              <li><strong>Pan</strong>: Click-drag or two-finger drag (touch).</li>
              <li><strong>Center</strong>: (Planned) recenters camera to track bounds.</li>
            </ul>
            <p>Status HUD shows session name, current lap, elapsed lap time, and peak trap speed seen so far.</p>
          </div>
        </z-accordion-item>
        <z-accordion-item zTitle="Cars & Tooltips" zValue="cars-help">
          <div class="help-block">
            <p>Hover a car to reveal an on-hover tooltip with enriched metadata (driver code, team color, perhaps last sector pace). This improves spatial awareness when the pack compresses.</p>
            <p>Hidden cars (unchecked) won‚Äôt display tooltips until re-enabled.</p>
          </div>
        </z-accordion-item>
      </z-accordion>
    </div>
    <footer class="help-footer">
      <div class="car-size-control">
        <div class="car-size-preview" [style.width.px]="carPreviewSize()*2" [style.height.px]="carPreviewSize()*1.2">
          <div class="car-size-svg-wrapper" [style.transform]="'scale(' + (carSizeScale()) + ')'" [innerHTML]="sanitizedCarSvg"></div>
        </div>
        <button z-button zSize="sm" (click)="decreaseCarSize()" aria-label="Decrease car size">‚àí</button>
        <span class="car-size-value">Car Size: {{ carSizeScale() | number:'1.0-2' }}x</span>
        <button z-button zSize="sm" (click)="increaseCarSize()" aria-label="Increase car size">+</button>
      </div>
      <button z-button zSize="sm" (click)="closeHelp()">Close</button>
    </footer>
  </div>
</div>